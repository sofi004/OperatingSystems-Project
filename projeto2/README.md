Coisas a fazer:
Não esquecer de por um while de verificção à volta de todos os writes e reads. Nos ems não temos esse while à volta de nehum dos writes!
Colocar as constantes para os switches
Enviar o valor de retorno das funções para o cliente
Enviar o session_id para o cliente
Transformar os buffers todos em 40 e colocar 40 numa constante